<%- include('../partials/top.ejs') %>
<small id="geo-status" data-lat="<%=place.loc.coordinates[0]%>" data-lng="<%=place.loc.coordinates[1]%>"></small>
<h2><%=place.name%> Info</h2>
<a href="/places"> Back to List of All Places</a>

<h5>Report Card(s)</h5>

<!-- List Report Cards for this PLACE -->
<div class="list-box">
  <ul>
    <% place.reportCards.forEach(reportCard => { %> <% if (reportCard.hasChangingTableW || reportCard.hasChangingTableM) { %>
    <li>
      <%= reportCard.createdAt.toLocaleString('en-US',{year: '2-digit', month: 'short', day: 'numeric'}) %>
      <span class="material-icons"> baby_changing_station </span>
      <%= reportCard.hasChangingTableW ? '(W)' : '' %> <%= reportCard.hasChangingTableM ? '(M)' : '' %>
    </li>
    <%}%> <% }) %>
  </ul>
</div>
<!-- display MAP showing THIS PLACE and USER LOCATION -->
<div id="map"></div>

<!-- MAP API - REMOVED API CALLBACK-->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2CGd_TVDT97bT076IBQWpm3h3gFtZGJM&&libraries=&v=weekly"></script>

<script>
  // get users GEO location
  // can take a while, need to run google API map initMap() call AFTER success(). using aysnc await worked!!
  async function success(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    status.textContent = 'Your location is displayed on the map';
    const thisPlaceLocation = { lat: parseFloat(status.dataset.lat), lng: parseFloat(status.dataset.lng) };
    const userLocation = { lat: latitude, lng: longitude };
    // status.textContent = `Lat: ${latitude} °, Lng: ${longitude} °`;
    //   mapLink.href = `https://www.openstreetmap.org/#map=18/${latitude}/${longitude}`;
    //   mapLink.textContent = `Latitude: ${latitude} °, Longitude: ${longitude} °`;

    // send to google map display
    await initMap(userLocation, thisPlaceLocation);
  }

  function error() {
    status.textContent = 'Unable to retrieve your location';
  }

  const status = document.querySelector('#geo-status');

  if (!navigator.geolocation) {
    status.textContent = 'Geolocation is not supported by your browser';
  } else {
    status.textContent = 'Locating…';
    navigator.geolocation.getCurrentPosition(success, error);
  }

  // placeholder function because GOOGLE MAPS API Call needs callback, but we are still waiting on browser to get user location.
  function booya() {
    console.log('boo ya');
  }

  // GOOGLE MAPS
  // Initialize and add the map.
  function initMap(userLocation, thisPlaceLocation) {
    // map centered at user
    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 1,
      center: userLocation,
    });
    // marker positioned at USER
    console.log(userLocation, 'user');
    const userMarker = new google.maps.Marker({
      position: userLocation,
      map: map,
    });

    // marker positioned at THIS PLACE
    console.log(thisPlaceLocation, 'this place');
    const placeMarker = new google.maps.Marker({
      // ! CANT GET PLACE FROM CONTEXT
      // position: place,

      position: thisPlaceLocation,
      map: map,
    });
  }
</script>

<%- include('../partials/bottom.ejs') %>
