<%- include('../partials/top.ejs', {user: user}) %>

<small id="geo-status"></small>

<!-- display MAP showing ALL PLACES and USER LOCATION -->
<div id="map"></div>

<a href="/places/new"><span class="material-icons"> add_location_alt </span>Add A New Place</a>

<h4>All Places</h4>
<div class="list-box">
  <ul>
    <!--  -->

    <% places.forEach((place) => { %>
    <li>
      <!-- use to pass data from server to front end -->
      <data class="geo-data" data-name="<%=place.name%>" data-lat="<%=place.loc.coordinates[0]%>" data-lng="<%=place.loc.coordinates[1]%>"></data>
      <!-- make place name a link to view place details / report cards  -->
      <a href="/places/<%=place._id%>"><%= place.name %></a>
      <!-- <ul>
        <li><%=place.loc.coordinates %></li>
      </ul> -->

      <!-- ADD REPORT  BUTTON  -->
      <form action="/places/<%=place._id%>/reportcards/new" method="GET">
        <button title="Grade This Place"><span class="material-icons"> thumbs_up_down </span></button>
      </form>

      <!-- EDIT PLACE BUTTON  -->
      <form action="/places/<%=place._id%>/edit" method="GET">
        <button title="Edit Place Details"><span class="material-icons"> edit_location_alt </span></button>
      </form>

      <!-- DELETE PLACE BUTTON  -->
      <!-- only available for authoring user  -->
      <% if (place.authorUserId._id.equals(user && user._id)) { %>
      <form action="/places/<%=place._id%>?_method=DELETE" method="POST">
        <button class="danger" title="Delete Place"><span class="material-icons"> clear </span></button>
      </form>
      <% } %>
    </li>
    <% }) %>
  </ul>
</div>

<!-- LOAD GEO LOCATION success() and error() FUNCTIONS  -->
<script src="/js/scripts.js"></script>
<!-- LOAD GOOGLE MAPS FUNCTIONS (called from scripts.js) -->
<script src="/js/maps.js"></script>

<!-- GOOGLE MAPS API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2CGd_TVDT97bT076IBQWpm3h3gFtZGJM&&libraries=&v=weekly"></script>
<script defer>
  const status = document.querySelector('#geo-status');
  const geoDataEls = document.querySelectorAll('.geo-data');

  // create new array of place lat/lng based off array of data elements containg the same
  const mapPlaces = [...geoDataEls].map((el) => {
    const latLng = {};
    const location = {};
    latLng.lat = parseFloat(el.dataset.lat);
    latLng.lng = parseFloat(el.dataset.lng);
    location.latLng = latLng;
    location.title = el.dataset.name;

    return location;
  });

  // initialize userLocation to default lat/lng. set later to accurate geolcation if possible
  let userLocation = { lat: 45, lng: -90 };

  if (!navigator.geolocation) {
    status.textContent = 'Geolocation is not supported by your browser.';
    // call map with default user position if not supported
    initMap(userLocation, mapPlaces);
  } else {
    status.textContent = 'Locatingâ€¦';
    console.log('1');
    // success() sets userLocation and calls initMap()
    // error() keeps default userLocation and calls initMaps
    navigator.geolocation.getCurrentPosition(success, error);
    console.log('2');
  }
</script>

<%- include('../partials/bottom.ejs') %>
